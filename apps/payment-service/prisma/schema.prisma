// Payment Service Prisma Schema
generator client {
    provider      = "prisma-client-js"
    output        = "../../../node_modules/.prisma/payment-client"
    binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Payment {
    id        String  @id @default(cuid())
    bookingId String  @map("booking_id")
    userId    String  @map("user_id")
    amount    Decimal
    currency  String  @default("USD")

    // Payment method and details
    paymentMethod PaymentMethodType @map("payment_method")
    paymentType   PaymentType       @map("payment_type")
    status        PaymentStatus     @default(PENDING)

    // Card details (encrypted)
    cardLast4       String? @map("card_last4")
    cardBrand       String? @map("card_brand")
    cardExpiryMonth Int?    @map("card_expiry_month")
    cardExpiryYear  Int?    @map("card_expiry_year")

    // Gateway details
    gatewayProvider      GatewayProvider @map("gateway_provider")
    gatewayTransactionId String?         @map("gateway_transaction_id")
    gatewayPaymentId     String?         @map("gateway_payment_id")
    gatewayResponse      Json?           @map("gateway_response")

    // Fees and breakdown
    processingFee Decimal? @map("processing_fee")
    platformFee   Decimal? @map("platform_fee")
    netAmount     Decimal? @map("net_amount")

    // Failure details
    failureReason String? @map("failure_reason")
    failureCode   String? @map("failure_code")

    // Timestamps
    initiatedAt DateTime  @default(now()) @map("initiated_at")
    processedAt DateTime? @map("processed_at")
    completedAt DateTime? @map("completed_at")
    failedAt    DateTime? @map("failed_at")
    refundedAt  DateTime? @map("refunded_at")
    createdAt   DateTime  @default(now()) @map("created_at")
    updatedAt   DateTime  @updatedAt @map("updated_at")

    // Relations
    refunds  Refund[]
    webhooks PaymentWebhook[]

    @@map("payments")
}

model Refund {
    id        String       @id @default(cuid())
    paymentId String       @map("payment_id")
    amount    Decimal
    reason    RefundReason
    status    RefundStatus @default(PENDING)

    // Gateway refund details
    gatewayRefundId String? @map("gateway_refund_id")
    gatewayResponse Json?   @map("gateway_response")

    // Processing details
    processedBy   String    @map("processed_by")
    processedAt   DateTime? @map("processed_at")
    failureReason String?   @map("failure_reason")

    // Timestamps
    requestedAt DateTime  @default(now()) @map("requested_at")
    completedAt DateTime? @map("completed_at")
    createdAt   DateTime  @default(now()) @map("created_at")
    updatedAt   DateTime  @updatedAt @map("updated_at")

    // Relations
    payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

    @@map("refunds")
}

model PaymentWebhook {
    id              String          @id @default(cuid())
    paymentId       String?         @map("payment_id")
    eventType       String          @map("event_type")
    gatewayProvider GatewayProvider @map("gateway_provider")

    // Webhook payload
    rawPayload Json    @map("raw_payload")
    signature  String?
    isValid    Boolean @default(false) @map("is_valid")

    // Processing status
    processed       Boolean @default(false)
    processingError String? @map("processing_error")

    // Timestamps
    receivedAt  DateTime  @default(now()) @map("received_at")
    processedAt DateTime? @map("processed_at")

    // Relations
    payment Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

    @@map("payment_webhooks")
}

model PaymentMethod {
    id        String            @id @default(cuid())
    userId    String            @map("user_id")
    type      PaymentMethodType
    isDefault Boolean           @default(false) @map("is_default")

    // Card details (encrypted)
    cardToken       String? @map("card_token") // Encrypted token from gateway
    cardLast4       String? @map("card_last4")
    cardBrand       String? @map("card_brand")
    cardExpiryMonth Int?    @map("card_expiry_month")
    cardExpiryYear  Int?    @map("card_expiry_year")
    cardHolderName  String? @map("card_holder_name")

    // Bank account details (encrypted)
    bankAccountToken String? @map("bank_account_token")
    bankLast4        String? @map("bank_last4")
    bankName         String? @map("bank_name")
    accountType      String? @map("account_type")

    // Digital wallet
    walletType  String? @map("wallet_type")
    walletToken String? @map("wallet_token")

    // Verification status
    isVerified Boolean   @default(false) @map("is_verified")
    verifiedAt DateTime? @map("verified_at")

    // Timestamps
    createdAt DateTime  @default(now()) @map("created_at")
    updatedAt DateTime  @updatedAt @map("updated_at")
    deletedAt DateTime? @map("deleted_at")

    @@map("payment_methods")
}

model TransactionLog {
    id          String          @id @default(cuid())
    paymentId   String?         @map("payment_id")
    type        TransactionType
    amount      Decimal
    currency    String          @default("USD")
    description String
    metadata    Json?

    // Gateway details
    gatewayProvider      GatewayProvider @map("gateway_provider")
    gatewayTransactionId String?         @map("gateway_transaction_id")
    gatewayResponse      Json?           @map("gateway_response")

    // Status
    status        TransactionStatus @default(PENDING)
    failureReason String?           @map("failure_reason")

    // Timestamps
    processedAt DateTime? @map("processed_at")
    createdAt   DateTime  @default(now()) @map("created_at")

    @@map("transaction_logs")
}

enum PaymentMethodType {
    CREDIT_CARD
    DEBIT_CARD
    BANK_ACCOUNT
    DIGITAL_WALLET
}

enum PaymentType {
    BOOKING_PAYMENT
    DEPOSIT
    REFUND
    PARTIAL_REFUND
    PENALTY
    ADDITIONAL_FEE
    PLATFORM_FEE
}

enum PaymentStatus {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
    CANCELLED
    REFUNDED
    PARTIALLY_REFUNDED
    DISPUTED
}

enum RefundReason {
    CUSTOMER_REQUEST
    BOOKING_CANCELLED
    SERVICE_ISSUE
    DUPLICATE_PAYMENT
    FRAUD
    OTHER
}

enum RefundStatus {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
    CANCELLED
}

enum GatewayProvider {
    STRIPE
    PAYPAL
    SQUARE
    RAZORPAY
    RAZORPAY_X
    CASHFREE
    PAYU
    PAYTM
    RAZORPAY_UPI
    RAZORPAY_NETBANKING
}

enum TransactionType {
    PAYMENT
    REFUND
    CHARGEBACK
    DISPUTE
    SETTLEMENT
    FEE
}

enum TransactionStatus {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
    CANCELLED
}
