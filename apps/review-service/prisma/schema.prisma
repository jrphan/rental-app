// Review Service Prisma Schema
generator client {
    provider = "prisma-client-js"
    output   = "../node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Review {
    id        String @id @default(cuid())
    bookingId String @map("booking_id")
    userId    String @map("user_id")
    vehicleId String @map("vehicle_id")
    ownerId   String @map("owner_id")

    // Review ratings (1-5 scale)
    overallRating       Int @map("overall_rating")
    cleanlinessRating   Int @map("cleanliness_rating")
    communicationRating Int @map("communication_rating")
    valueRating         Int @map("value_rating")
    conditionRating     Int @map("condition_rating")

    // Review content
    title   String?
    comment String?
    images  String[] @default([])

    // Response from owner
    ownerResponse   String?   @map("owner_response")
    ownerResponseAt DateTime? @map("owner_response_at")

    // Review status
    isPublished  Boolean @default(true) @map("is_published")
    isVerified   Boolean @default(false) @map("is_verified")
    isHelpful    Int     @default(0) @map("is_helpful")
    isNotHelpful Int     @default(0) @map("is_not_helpful")

    // Moderation
    isFlagged   Boolean   @default(false) @map("is_flagged")
    flagReason  String?   @map("flag_reason")
    moderatedAt DateTime? @map("moderated_at")
    moderatedBy String?   @map("moderated_by")

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    helpfulVotes ReviewHelpfulVote[]

    @@map("reviews")
}

model ReviewHelpfulVote {
    id        String   @id @default(cuid())
    reviewId  String   @map("review_id")
    userId    String   @map("user_id")
    isHelpful Boolean  @map("is_helpful")
    createdAt DateTime @default(now()) @map("created_at")

    // Relations
    review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

    @@unique([reviewId, userId])
    @@map("review_helpful_votes")
}

model ReviewReport {
    id          String       @id @default(cuid())
    reviewId    String       @map("review_id")
    reportedBy  String       @map("reported_by")
    reason      ReportReason
    description String?
    status      ReportStatus @default(PENDING)

    // Moderation
    reviewedBy  String?   @map("reviewed_by")
    reviewedAt  DateTime? @map("reviewed_at")
    actionTaken String?   @map("action_taken")

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("review_reports")
}

model ReviewTemplate {
    id          String  @id @default(cuid())
    name        String
    description String?
    category    String

    // Template structure
    fields   Json // Array of field definitions
    isActive Boolean @default(true) @map("is_active")

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("review_templates")
}

model ReviewAnalytics {
    id          String   @id @default(cuid())
    vehicleId   String?  @map("vehicle_id")
    ownerId     String?  @map("owner_id")
    period      String // 'daily', 'weekly', 'monthly', 'yearly'
    periodStart DateTime @map("period_start")
    periodEnd   DateTime @map("period_end")

    // Metrics
    totalReviews       Int   @map("total_reviews")
    averageRating      Float @map("average_rating")
    ratingDistribution Json  @map("rating_distribution") // {1: count, 2: count, ...}

    // Breakdown by category
    cleanlinessAvg   Float @map("cleanliness_avg")
    communicationAvg Float @map("communication_avg")
    valueAvg         Float @map("value_avg")
    conditionAvg     Float @map("condition_avg")

    // Trends
    reviewCount  Int @map("review_count")
    helpfulVotes Int @map("helpful_votes")
    reportsCount Int @map("reports_count")

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")

    @@unique([vehicleId, ownerId, period, periodStart])
    @@map("review_analytics")
}

enum ReportReason {
    SPAM
    INAPPROPRIATE_CONTENT
    FAKE_REVIEW
    HARASSMENT
    OFFENSIVE_LANGUAGE
    IRRELEVANT
    OTHER
}

enum ReportStatus {
    PENDING
    UNDER_REVIEW
    RESOLVED
    DISMISSED
}
